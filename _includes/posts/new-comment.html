{% if jekyll.environment == 'production' %}
    <form id='new-comment-form' action='https://services.alitebyte.com/comment' 
        method='POST'>
{% else %}
    <form id='new-comment-form' action='http://127.0.0.1:4001/comment' 
        method='POST'>
{% endif %}
    <input type='hidden' name='perma' value='{{ page.url }}' />
    <h3>Leave a Comment</h3>
    <div class='form-row'>
        <div class='form-group col'>
            <label for='new-comment-text'>Comment</label>
            <textarea id='new-comment-text' class='form-control' required
                    name='text' rows='4' maxlength="1000"></textarea>
            <small class='text-muted form-text'>
                0/1000 characters
            </small>
        </div>
    </div>
    <div class='form-row'>
        <div class='form-group col-md-6'>
            <label for='new-comment-name'>Display Name</label>
            <input type='text' id='new-comment-name' maxlength='50'
                required name='name' class='form-control' />
        </div>
        <div class='form-group col-md-6'>
            <label for='new-comment-persona'>
                Persona 
                <small><em>Optional</em></small>
            </label>
            <input type='text' id='new-comment-persona' class='form-control'
                name='persona' maxlength="255"
                placeholder="@Twitter / Github name / Email (Gravatar)" />
            <small class='text-muted form-text'>
                This will be used to grab your profile picture. Only the image
                data will be stored outside of your browser. (More info link)
            </small>
            <img id='persona-preview' class='user-persona' />
        </div>
    </div>
    <div class='form-row'>
        <div class='form-group col'>
            <div class='custom-control custom-checkbox'>
                <input type="checkbox" class="custom-control-input" 
                        id="new-comment-anon" />
                <label class="custom-control-label" for='new-comment-anon'>
                    I would rather remain anonymous
                </label>
            </div>
        </div>
    </div>
    <input type='text' name='address' class='d-none' title='leave blank' />
    <div class='form-row'>
        <div class='form-group'>
            <button id='new-comment' type='submit' class='btn btn-primary'>
                <span class='spinner-border spinner-border-sm d-none'></span>
                Submit
            </button>
        </div>
    </div>
</form>

<script type='text/javascript'>
    $(function(){
        let comment_txt = $('#new-comment-text');
        let persona_inputs = $('#new-comment-name, #new-comment-persona');
        let persona_preview = $('#persona-preview');
        let anon_input = $('#new-comment-anon');
        let btn = $('#new-comment');
        let form = $('#new-comment-form')
        
        anon_input.on('change', function(){
            let remain_anon = anon_input.prop('checked');
            if (remain_anon) {
                $('#new-comment-name').removeAttr('required')
                persona_inputs.val('');
                persona_inputs.attr('disabled', 'disabled');
                persona_preview[0].src = '';
                persona_preview[0].width = 0;
                persona_preview[0].height = 0;
            } else {
                persona_inputs.removeAttr('disabled');
                $('#new-comment-name').attr('required', 'required');
            }
        });
        let persona_intent = null;
        $('#new-comment-persona').on('keyup', function(){
            if (persona_intent != null) {
                clearTimeout(persona_intent);
            }
            let persona = $(this).val();
            persona_intent = setTimeout(function(){
                get_persona_image(persona);
            }, 500);
        })

        form.on('submit', function(event){
            event.preventDefault();

            // Post form ajax
            // Need to get the image again on the server then base64 there
            
        });
    });

    function get_persona_image(persona) {
        let url = null;
        if (persona.startsWith('@')) {
            // Twitter handle
            url = 'https://twitter.com/';
            url += persona + '/profile_image?size=normal';
        } else if (persona.includes('@')) {
            // Gravatar email
            url = 'http://www.gravatar.com/avatar/';
            url += $.md5(persona) + '?s=80';
        } else {
            // Github username
            url = 'https://github.com/';
            url += persona + '.png?size=80'
        }

        let img = $('#persona-preview')[0];
        img.src = url;
        img.width = 80;
        img.height = 80;
    }
</script>
